import { defineStore } from 'pinia'
import axios from "axios"
import { useUserStore  } from './user'

// You can name the return value of `defineStore()` anything you want,
// but it's best to use the name of the store and surround it with `use`
// and `Store` (e.g. `useUserStore`, `useCartStore`, `useProductStore`)
// the first argument is a unique id of the store across your application
export const useChoreStore = defineStore('chore', {
  state: () => ({ 
    areas: [],
    chores: [],
    areagroups: [],
    users: [],
    historyitems: [],
    weeklytotals: [],
    units: ['day(s)', 'week(s)', 'month(s)', 'year(s)'],
    intervals: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31],
    areaicons: [
      'mdi-fridge',
      'mdi-stove',
      'mdi-faucet',
      'mdi-toilet',
      'mdi-paper-roll',
      'mdi-sofa',
      'mdi-television',
      'mdi-table-chair',
      'mdi-table-furniture',
      'mdi-bed',
      'mdi-dresser',
      'mdi-cradle',
      'mdi-teddy-bear',
      'mdi-desk',
      'mdi-desk-lamp',
      'mdi-table-picnic',
      'mdi-car-back',
      'mdi-tree',
      'mdi-tumble-dryer',
      'mdi-washing-machine',
    ],
    med_thresh: 0,
    high_thresh: 10,
    vacation_mode: false,
  }),
    getters: {
      getAreas(state){
        state.areas.forEach((area) => {
        if (area.dirtiness <= state.med_thresh ) {
          area.dirtycolor = 'success'
        }else if (area.dirtiness > state.med_thresh && area.dirtiness <= state.high_thresh){
          area.dirtycolor = 'warning'
        }else if (area.dirtiness > state.high_thresh){
          area.dirtycolor = 'alert'
        }
      })

        return state.areas
      },
      getAreaGroups(state){
        return state.areagroups
      },
      getFilteredChores: (state) => (filter) => {
        let tempChores = state.chores
        
        if (filter != 'All' && filter) {
          tempChores = tempChores.filter((chore) => {
            return (chore.area.area_name == filter)
          })
        }

        tempChores.forEach((chore) => {
          chore.repeat = chore.intervalNumber + " " + chore.unit
          if (chore.assignee) {
            chore.isAssigned = true
          } else {
            chore.isAssigned = false
          }
          if (chore.duedays < 0) {
            chore.isOverdue = true
          }else{
            chore.isOverdue = false
          }
          if (chore.dirtiness <= state.med_thresh ) {
            chore.dirtycolor = 'success'
          }else if (chore.dirtiness > state.med_thresh && chore.dirtiness <= state.high_thresh){
            chore.dirtycolor = 'warning'
          }else if (chore.dirtiness > state.high_thresh){
            chore.dirtycolor = 'error'
          }
        })

        return tempChores;
      },
      getChores(state){
        state.chores.forEach((chore) => {
          chore.repeat = chore.intervalNumber + " " + chore.unit
          if (chore.assignee) {
            chore.isAssigned = true
          } else {
            chore.isAssigned = false
          }
          if (chore.duedays < 0) {
            chore.isOverdue = true
          }else{
            chore.isOverdue = false
          }
          if (chore.dirtiness <= state.med_thresh ) {
            chore.dirtycolor = 'success'
          }else if (chore.dirtiness > state.med_thresh && chore.dirtiness <= state.high_thresh){
            chore.dirtycolor = 'warning'
          }else if (chore.dirtiness > state.high_thresh){
            chore.dirtycolor = 'error'
          }
        })

        return state.chores
      },
      getUsers(state){
        return state.users
      },
      getHistoryItems(state){
        return state.historyitems
      },
      getWeeklyTotals(state){
        return state.weeklytotals
      },
      getHighThresh(state){
        return state.high_thresh
      },
      getMedThresh(state){
        return state.med_thresh
      },
      getVacationMode(state){
        return state.vacation_mode
      },
    },
    actions: {
      async fetchAll() {
        try {
          this.fetchAreas()
          this.fetchChores()
          this.fetchHistoryItems()
          this.fetchUsers()
          this.fetchWeeklyTotals()
          this.fetchOptions()
          this.fetchAreaGroups()
        }
        catch (error) {
          alert(error)
          console.log(error)
        }
      },
      async fetchAreas() {
        try {
          const data = await axios.get('https://chores.danielleandjohn.love/api/areas/')
          this.areas = data.data
          console.log(data.data)
        }
        catch (error) {
          alert(error)
          console.log(error)
        }
      },
      async fetchAreaGroups() {
        try {
          const data = await axios.get('https://chores.danielleandjohn.love/api/areagroups/')
          this.areagroups = data.data
          console.log(data.data)
        }
        catch (error) {
          alert(error)
          console.log(error)
        }
      },
      async fetchChores() {
        try {
          const data = await axios.get('https://chores.danielleandjohn.love/api/chores/')
          this.chores = data.data
        }
        catch (error) {
          alert(error)
          console.log(error)
        }
      },
      async fetchWeeklyTotals() {
        try {
          const data = await axios.get('https://chores.danielleandjohn.love/api/historyitems/weekly_totals/')
          this.weeklytotals = data.data
        }
        catch (error) {
          alert(error)
          console.log(error)
        }
      },
      async fetchUsers() {
        try {
          const data = await axios.get('https://chores.danielleandjohn.love/api/users/')
          this.users = data.data
        }
        catch (error) {
          alert(error)
          console.log(error)
        }
      },
      async fetchHistoryItems() {
        try {
          const data = await axios.get('https://chores.danielleandjohn.love/api/historyitems/')
          this.historyitems = data.data
        }
        catch (error) {
          alert(error)
          console.log(error)
        }
      },
      async fetchOptions() {
        try {
          const data = await axios.get('https://chores.danielleandjohn.love/api/options/')
          this.vacation_mode = data.data[0].vacation_mode
          this.med_thresh = data.data[0].med_thresh
          this.high_thresh = data.data[0].high_thresh
        }
        catch (error) {
          alert(error)
          console.log(error)
        }
      },
      async addHistoryItem(chore) {
        const userstore = useUserStore();
        const data = {
          chore_id: chore.id,
          completed_by_id: userstore.id
        }
        
        try {
          // Make a POST request to your API endpoint
          const response = await axios.post('https://chores.danielleandjohn.love/api/historyitem-create/', data);

          // Add area to local storage
          //this.areas.push(area);
          this.fetchHistoryItems();
          this.fetchWeeklyTotals();

          // Handle the response here (e.g., show a success message)
          console.log('Response:', response.data);
        } catch (error) {
          // Handle errors (e.g., show an error message)
          console.log('Error:', error);
        }
      },
      async addArea(area) {
        try {
          // Make a POST request to your API endpoint
          const response = await axios.post('https://chores.danielleandjohn.love/api/areas/', area);

          // Add area to local storage
          //this.areas.push(area);
          this.fetchAreas();

          // Handle the response here (e.g., show a success message)
          console.log('Response:', response.data);
        } catch (error) {
          // Handle errors (e.g., show an error message)
          console.log('Error:', error);
        }
      },
      async editArea(area) {
        try {
          console.log("Area Edited", area.id)
          // Make a POST request to your API endpoint
          const response = await axios.patch('https://chores.danielleandjohn.love/api/areas/' + area.id + '/', area);

          // Add area to local storage
          //this.areas.push(area);
          this.fetchAreas();
          this.fetchChores();

          // Handle the response here (e.g., show a success message)
          console.log('Response:', response.data);
        } catch (error) {
          // Handle errors (e.g., show an error message)
          console.log('Error:', error);
        }
      },
      async addChore(chore) {
        try {
          // Make a POST request to your API endpoint
          const newDate = new Date()
          const today = new Date()
          if ( chore.unit == 'day(s)' ){
            newDate.setDate(today.getDate()+chore.intervalNumber)
          } else if ( chore.unit == 'week(s)' ){
            newDate.setDate(today.getDate()+(chore.intervalNumber*7))
          } else if ( chore.unit == 'month(s)' ){
            newDate.setMonth(today.getMonth()+chore.intervalNumber)
          } else if ( chore.unit == 'year(s)' ){
            newDate.setFullYear(today.getFullYear()+chore.intervalNumber)
          }

          chore.nextDue = newDate.toISOString().split('T')[0]
          const response = await axios.post('https://chores.danielleandjohn.love/api/chores/', chore);
          // Add area to local storage
          //this.chores.push(chore);
          this.fetchChores();
          this.fetchAreas();

          // Handle the response here (e.g., show a success message)
          console.log('Response:', response.data);
        } catch (error) {
          // Handle errors (e.g., show an error message)
          console.log('Error:', error);
        }
      },
      async claimChore(chore,user) {
        console.log('Chore claimed', chore.id)

        const data = {
          "assignee": { 'id': ''}
        }
        if (chore.assignee){
          data.assignee = null
        } else {
          data.assignee.id = user
        }

        try {
          // Make a POST request to your API endpoint
          const response = await axios.patch('https://chores.danielleandjohn.love/api/chores/' + chore.id +'/', data);

          // Add area to local storage
          //this.areas.push(area);
          this.fetchChores();

          // Handle the response here (e.g., show a success message)
          console.log('Response:', response.data);
        } catch (error) {
          // Handle errors (e.g., show an error message)
          console.log('Error:', error);
        }
      },
      async completeChore(chore) {

        console.log('Chore completed', chore.id)
        try {
          // Make a POST request to your API endpoint
          const response = await axios.patch('https://chores.danielleandjohn.love/api/chore-complete/' + chore.id +'/');

          // Add area to local storage
          //this.areas.push(area);
          this.fetchChores();
          this.fetchAreas();
          this.addHistoryItem(chore);
          // Handle the response here (e.g., show a success message)
          console.log('Response:', response.data);
        } catch (error) {
          // Handle errors (e.g., show an error message)
          console.log('Error:', error);
        }
      },
      async snoozeChore(chore) {
        const data = {}
        const dateFormat = (date) => {
          const day = date.getDate();
          const month = date.getMonth() + 1;
          const year = date.getFullYear();
      
          const dateFormat = year + '-' + month + '-' + day;
      
          return dateFormat;
        }

        data.next_due_date = dateFormat(chore.nextDue)
        
        console.log('Chore snoozed', chore.id, data)
        try {
          // Make a POST request to your API endpoint
          const response = await axios.patch('https://chores.danielleandjohn.love/api/chore-snooze/' + chore.id +'/', data);

          // Add area to local storage
          //this.areas.push(area);
          this.fetchChores();
          // Handle the response here (e.g., show a success message)
          console.log('Response:', response.data);
        } catch (error) {
          // Handle errors (e.g., show an error message)
          console.log('Error:', error);
        }
      },
      async toggleChore(chore) {
        console.log('Chore toggled', chore.id)

        const data = {
          "active": ''
        }
        if (chore.active == false){
          data.active = true
        } else {
          data.active = false
        }

        try {
          // Make a POST request to your API endpoint
          const response = await axios.patch('https://chores.danielleandjohn.love/api/chores/' + chore.id +'/', data);

          // Add area to local storage
          //this.areas.push(area);
          this.fetchChores();

          // Handle the response here (e.g., show a success message)
          console.log('Response:', response.data);
        } catch (error) {
          // Handle errors (e.g., show an error message)
          console.log('Error:', error);
        }
      },
      async saveChore(chore) {
        console.log('Chore saved', chore.id)
      },
      async deleteChore(chore) {
        console.log('Chore deleted', chore.id)

        try {
          // Make a POST request to your API endpoint
          const response = await axios.delete('https://chores.danielleandjohn.love/api/chores/' + chore.id +'/');

          // Add area to local storage
          //this.areas.push(area);
          this.fetchChores();
          this.fetchAreas();
          this.fetchHistoryItems();
          this.fetchWeeklyTotals();

          // Handle the response here (e.g., show a success message)
          console.log('Response:', response.data);
        } catch (error) {
          // Handle errors (e.g., show an error message)
          console.log('Error:', error);
        }
      },
      async deleteArea(area) {
        console.log('Area deleted', area.id)

        try {
          // Make a POST request to your API endpoint
          const response = await axios.delete('https://chores.danielleandjohn.love/api/areas/' + area.id +'/');

          // Add area to local storage
          //this.areas.push(area);
          this.fetchAreas();
          this.fetchChores();
          this.fetchHistoryItems();
          this.fetchWeeklyTotals();

          // Handle the response here (e.g., show a success message)
          console.log('Response:', response.data);
        } catch (error) {
          // Handle errors (e.g., show an error message)
          console.log('Error:', error);
        }
      },
    },
    persist: true,
  })